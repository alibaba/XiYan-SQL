# XiYan-SQLTraining æ¡†æ¶


## æ–°é—»ğŸ”¥

+ `2025-10-30` ğŸŒŸæˆ‘ä»¬éå¸¸é«˜å…´åœ°å‘å¸ƒäº†XiYan-SQLçš„ç¬¬ä¸€ç‰ˆè®­ç»ƒæ¡†æ¶**XiYan-SQLTraining**ï¼Œæ¬¢è¿å¤§å®¶ä½¿ç”¨ï¼Œåœ¨æœªæ¥æˆ‘ä»¬ä¼šè¡¥å……æ›´å¤šçš„ä¿¡æ¯æ¥å®Œå–„è¿™é¡¹æ¡†æ¶ã€‚



## ä»‹ç»


XiYan-SQLTraining æ¡†æ¶æ˜¯XiYanæå‡ºçš„ç‰¹åˆ«é’ˆå¯¹Text-to-SQLä»»åŠ¡çš„å¤§æ¨¡å‹åè®­ç»ƒæ¡†æ¶ï¼Œç›®å‰ä¸»è¦æ”¯æŒåŠŸèƒ½å¦‚ä¸‹ï¼›
- [x] åŸç”Ÿæ•°æ®è½¬ä¸ºè®­ç»ƒæ•°æ®
- [x] è®­ç»ƒæ•°æ®å¢å¼º
- [x] åŸºç¡€æ¨¡å‹Text2SQLä»»åŠ¡å¾®è°ƒ
- [x] XiYanSQL MOEå¤šæ–¹è¨€æ¨¡å‹è®­ç»ƒ 
- [x] æ¨¡å‹æ¨ç†/è¯„æµ‹
- [ ] Text2SQLç»§ç»­GRPOè®­ç»ƒ
- [ ] ä¸åŒç±»å‹SQLæ¨¡å‹é›†æˆ
- [ ] ...

æ¡†æ¶æ­£åœ¨æ­£åœ¨å®Œå–„ä¸­ï¼Œæ¬¢è¿å„ä½ä½¿ç”¨è€…è´¡çŒ®ï½


## ä½¿ç”¨æ–¹æ³•


### ç¯å¢ƒå‡†å¤‡

1. **åˆ›å»ºCondaç¯å¢ƒ** ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸ºè®­ç»ƒåˆ›å»ºå¹¶æ¿€æ´»æ–°ç¯å¢ƒï¼š
```bash
conda create -n xiyansql python=3.10
conda activate xiyansql
```


2. **å®‰è£…ä¾èµ–** æ¿€æ´»ç¯å¢ƒåï¼Œé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…å¿…éœ€çš„ä¾èµ–åŒ…ï¼š
```bash
pip install -r requirements.txt
```
nvié©±åŠ¨cudaç‰ˆæœ¬11.8-12.4æµ‹è¯•å‡å¯ä»¥ï¼Œä½†æ˜¯æ‰€éœ€ä¾èµ–çš„ç‰ˆæœ¬å¯ä»¥æ ¹æ®æƒ…å†µè¿›è¡Œå‡çº§ã€‚


### æ•°æ®å‡†å¤‡

#### å·²ç»æœ‰å®Œæ•´çš„è®­ç»ƒæ•°æ®

è¯·æŒ‰ç…§JSON LISTæ–‡ä»¶æ ¼å¼å‡†å¤‡ï¼Œæ–‡ä»¶å†…å®¹æ ·ä¾‹å¦‚ä¸‹ï¼Œå…¶ä¸­æ¯æ¡æ•°æ®éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š
```json
[
  {
    "id": 0,
    "conversations": [
      {
        "role": "user",
        "content": "ä½ æ˜¯ä¸€åSQLiteä¸“å®¶ï¼Œxxx..."
      },
      {
        "role": "assistant",
        "content": "SELECT xxx..."
      }
    ],
    "sql_type": "sqlite"
  },
  {
    "id": 1,
    "conversations": [
      {
        "role": "user",
        "content": "ä½ æ˜¯ä¸€åSQLiteä¸“å®¶ï¼Œxxx..."
      },
      {
        "role": "assistant",
        "content": "SELECT xxx..."
      }
    ],
    "sql_type": "sqlite"
  }
]
```
è®­ç»ƒæ•°æ®æ ·ä¾‹æ–‡ä»¶å¦‚`train/datasets/train_examples.json`

#### ä½ ä¹Ÿå¯ä»¥ä»åŸå§‹æ•°æ®å¼€å§‹æ„å»ºï¼Œæµç¨‹åœ¨data/æ–‡ä»¶å¤¹ä¸­ï¼š

1. é¦–å…ˆå¤„ç†åŸå§‹æ•°æ®ï¼Œå»ºè®®åœ¨`data_warehouse`ä¸‹ä¸ºæ¯å—æ•°æ®åˆ›å»ºä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶å¤¹ï¼Œå¦‚`data_warehouse/bird_train`ï¼Œç„¶åå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆå¤„ç†å¥½å¯é›†æˆçš„çš„æ•°æ®é›†ï¼š
```bash
bash data_processing.sh
```
è¾“å…¥å‚æ•°åˆ†åˆ«ä¸º`raw_data_path` åŸå§‹æ•°æ®è·¯å¾„ï¼Œ`db_conn_config`æ•°æ®åº“é…ç½®ï¼Œ`processed_data_dir`å¤„ç†å¥½ä¿å­˜çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œ`save_mschema_dir`æ˜¯å¦ä¿å­˜mschemaæ–‡ä»¶ï¼Œ`save_to_configs`å¤„ç†å¥½çš„æ•°æ®ä¿å­˜åˆ°æ•°æ®é…ç½®æ–‡ä»¶ä¸­ã€‚
è¯¥å¤„ç†è¿‡ç¨‹ä¸»è¦æ¶‰åŠä»æ•°æ®åº“ä¸­è¯»å–ç”Ÿæˆm-schemaå½¢å¼çš„db schemaï¼Œå¹¶å°†å¤„ç†å¥½çš„æ•°æ®å†™å…¥å®Œæ•´çš„é…ç½®æ–‡ä»¶ä»“åº“ä¸­ï¼Œæ–¹ä¾¿åç»­é€‰æ‹©æ•°æ®ä½¿ç”¨ã€‚
`data_processing.sh`ä¸­ç»™å‡ºäº†ä¸€ä¸ªä½¿ç”¨æ ·ä¾‹ã€‚

2. æ•°æ®ç»„è£…ï¼Œå°†å¤„ç†å¥½çš„è‡³å°‘ä¸€ä¸ªæ•°æ®é›†æ‰“åŒ…ç»„è£…æˆæœ€ç»ˆé€ç»™æ¨¡å‹è®­ç»ƒçš„æ•°æ®

```bash
bash data_assembler.sh
```
è¾“å…¥å‚æ•°`dataset_config_path` ä¸ºæ•°æ®é…ç½®æ–‡ä»¶å…¶ä¸­å¯ä»¥æ”¾ç½®å¤šä¸ªæ•°æ®é›†å—ï¼Œ`save_path`ä¸ºæœ€ç»ˆè®­ç»ƒæ•°æ®è¾“å‡ºè·¯å¾„ã€‚
è¯¥è¿‡ç¨‹æ¶‰åŠåˆ°æ•°æ®çš„ç»„è£…ï¼Œæ•°æ®å¤„ç†ï¼ŒæŒ‰ç…§promptç”Ÿæˆè®­ç»ƒæ ¼å¼æ•°æ®ç­‰ã€‚
`data_assembler.sh`ä¸­ç»™å‡ºäº†ä¸€ä¸ªä½¿ç”¨æ ·ä¾‹ã€‚


### æ¨¡å‹è®­ç»ƒ

æ•´ä½“æµç¨‹åœ¨`train/`æ–‡ä»¶å¤¹ä¸­

1. å‡†å¤‡æ¨¡å‹ï¼Œåœ¨`train/utils`ä¸­æä¾›äº†ä¸‹è½½æ¨¡å‹çš„è„šæœ¬ï¼Œå¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µé€‰æ‹©åœ¨ä½•ç§æºå¤´ä¸‹è½½ã€‚
```bash
python model_download.py
```
2. SFT è®­ç»ƒè„šæœ¬ä¸ºxiyan_sft.sh
```bash
bash xiyan_sft.sh
```
å…¶ä¸­éœ€è¦å‡†å¤‡å¥½å¦‚ä¸Šæ‰€è¿°çš„è®­ç»ƒæ•°æ®ï¼Œæ¨¡å‹ï¼Œè®­ç»ƒè¶…å‚æ•°ï¼Œè¾ƒå¤§çš„æ¨¡å‹å¯ä»¥é€‰æ‹©å¼€å¯loraï¼Œï¼ˆæ¨èå¯ä»¥å…ˆé‡‡ç”¨QWEN2.5ç³»åˆ—æ¨¡å‹å¼€å¯è®­ç»ƒï¼‰ã€‚
3. å¦‚æœä»¥loraæ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œä¿å­˜æ¨¡å‹çš„adapterï¼Œéœ€è¦ä¸åŸæ¨¡å‹è¿›è¡Œåˆå¹¶ï¼Œè„šæœ¬ä½äº`utils/adapter_merge.py`ã€‚


### æ¨¡å‹è¯„æµ‹

æ•´ä½“æµç¨‹åœ¨`evaluation/`æ–‡ä»¶å¤¹ä¸­ï¼Œå»ºè®®æ¯éƒ¨åˆ†æ•°æ®ç‹¬ç«‹ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¦‚`evaluation/bird_evaluation`

1. æ¨¡å‹æ¨ç†
```bash
bash sql_infer.sh
```
è¾“å…¥å‚æ•°`model_name_or_path`æ¨¡å‹åœ°å€ï¼Œ`expr_version`ä¸ºç‰ˆæœ¬å·ï¼Œ`test_set_path`æµ‹è¯•é›†è·¯å¾„ï¼Œ`batch_size`ä¸ºå¹¶å‘å¤„ç†å¤§å°ã€‚

2. æ¨ç†ç»“æœè¯„æµ‹

```bash
bash sql_eval.sh
```

è¾“å…¥å‚æ•°`pred_sql_path`ä¸ºé¢„æµ‹sqlè·¯å¾„ï¼Œ`test_sql_path`ä¸ºæµ‹è¯•é›†è·¯å¾„åŒ…å«ground-truth sqlï¼Œ`db_conn_config`ä¸ºéœ€è¿æ¥çš„æ•°æ®åº“é…ç½®ï¼Œ`save_eval_path`ä¸ºä¿å­˜è·¯å¾„ã€‚



## è”ç³»æˆ‘ä»¬

å¦‚æœæ‚¨å¯¹æˆ‘ä»¬çš„ç ”ç©¶æˆ–äº§å“æ„Ÿå…´è¶£ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚

#### è”ç³»ä¿¡æ¯:

åˆ˜ä¹‰å¯Œ, zhencang.lyf@alibaba-inc.com

#### åŠ å…¥æˆ‘ä»¬çš„é’‰é’‰ç¾¤

<a href="https://github.com/alibaba/XiYan-SQL/XiYan-SQLTraining/blob/imgs/xiyansql_dingding.png">Ding Groupé’‰é’‰ç¾¤</a> 

## åº”ç”¨
æ¬¢è¿å¤§å®¶ä½“éªŒåŸºäºXiYan-SQLæ‰“é€ çš„æ™ºèƒ½é—®æ•°è§£å†³æ–¹æ¡ˆâ€”â€”**æè¨€GBI**ã€‚
ç™»å½•é˜¿é‡Œäº‘ç™¾ç‚¼-åº”ç”¨å¹¿åœº-æè¨€GBIï¼Œä»»ä½•äº§å“ä½“éªŒåŠæ•ˆæœä¼˜åŒ–å»ºè®®æ¬¢è¿ä¸æˆ‘ä»¬äº¤æµã€‚

äº§å“ä»‹ç»è¯·è®¿é—®ï¼šhttps://help.aliyun.com/zh/model-studio/user-guide/brief-introduction-of-gbi-products

ä½“éªŒäº§å“è¯·è®¿é—®ï¼šhttps://bailian.console.aliyun.com/xiyan

äº§å“é’‰ç¾¤ï¼š94725009401




## å¼•ç”¨
å¦‚æœæ‚¨è§‰å¾—æˆ‘ä»¬çš„å·¥ä½œå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç»™æˆ‘ä»¬ä¸€ä¸ªå¼•ç”¨ã€‚

```bibtex
@article{XiYanSQL,
      title={XiYan-SQL: A Novel Multi-Generator Framework For Text-to-SQL}, 
      author={Yifu Liu and Yin Zhu and Yingqi Gao and Zhiling Luo and Xiaoxia Li and Xiaorong Shi and Yuntao Hong and Jinyang Gao and Yu Li and Bolin Ding and Jingren Zhou},
      year={2025},
      eprint={2507.04701},
      archivePrefix={arXiv},
      primaryClass={cs.CL},
      url={https://arxiv.org/abs/2507.04701}, 
}
```

